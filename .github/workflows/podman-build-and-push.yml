# Name of the workflow, displayed in the GitHub Actions tab.
name: Build and Push Image to GHCR with Podman

# Events that trigger this workflow.
on:
  push:
    branches:
      - main # Trigger on pushes to the 'main' branch.
    tags:
      - 'v*.*.*' # Also trigger on new tags like v1.0.0.

  # Allows you to run this workflow manually from the Actions tab.
  workflow_dispatch:

# Permissions needed for the workflow.
# 'packages: write' is essential for pushing to GitHub Container Registry.
# 'contents: read' is needed to checkout the repository code.
permissions:
  contents: read
  packages: write

# Define the jobs to be executed.
jobs:
  build-and-push-image:
    runs-on: ubuntu-latest # The type of runner that the job will run on.

    steps:
      # Step 1: Checkout the repository code.
      # This action checks out your repository under $GITHUB_WORKSPACE,
      # so your workflow can access it.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Extract metadata (tags, labels) for the image.
      # This action helps in generating standard image tags and labels.
      - name: Image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }} # Define the image name for GHCR.
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=semver,pattern=v{{version}}
            type=sha,format=short

      # Step 3: Set up Podman.
      # Ubuntu-latest runners usually have Podman pre-installed, but this step
      # ensures it's ready for use and can install it if missing.
      - name: Install Podman (if not already present)
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      # Step 4: Log in to GitHub Container Registry (GHCR) using Podman.
      # Uses the GITHUB_TOKEN to authenticate with GHCR.
      - name: Log in to GitHub Container Registry with Podman
        run: echo ${{ secrets.GITHUB_TOKEN }} | podman login ghcr.io -u ${{ github.actor }} --password-stdin

      # Step 5: Build the image using Podman.
      # This step builds the image from your Dockerfile using Podman.
      # We use the first tag generated by the metadata action as the primary tag for building.
      - name: Build image with Podman
        # Get the first tag from the generated list to use for building.
        # This typically ensures we have at least one valid tag.
        run: |
          IMAGE_TAGS="${{ steps.meta.outputs.tags }}"
          FIRST_TAG=$(echo "$IMAGE_TAGS" | head -n 1)
          echo "Building image with tag: $FIRST_TAG"
          pwd
          cd multidb-without-tracing
          podman build --tag multidbx .
          # Store all generated tags as an environment variable for the next step.
          echo "ALL_IMAGE_TAGS=${IMAGE_TAGS}" >> $GITHUB_ENV

      # Step 6: Push the image to GitHub Container Registry using Podman.
      # This step pushes the built image with all generated tags to GHCR.
      - name: Push image to GHCR with Podman
        run: |
          # Split the tags into an array and push each one.
          IFS=$'\n' read -d '' -r -a tags_array <<< "$ALL_IMAGE_TAGS"
          for tag in "${tags_array[@]}"; do
            echo "Pushing image tag: $tag"
            podman push "$tag"
          done
